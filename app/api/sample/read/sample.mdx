import { NextResponse } from "next/server";
import { SerialPort } from 'serialport';
import { DelimiterParser } from '@serialport/parser-delimiter';

import deviceInfo from '@/device-info.json';

type DeviceInfo = {
    serialNumber?: string;
    productId?: string;
    vendorId?: string;
    baudRate: number;
    Port: string;
};

let bindSerialPort: SerialPort;
let parser: DelimiterParser;

// Initialize the RFID reader
const initializeReader = (deviceInfo: DeviceInfo) => {
    bindSerialPort = new SerialPort({
        path: deviceInfo.Port,
        baudRate: deviceInfo.baudRate,
        autoOpen: false
    });

    parser = bindSerialPort.pipe(new DelimiterParser({ delimiter: '\n' }));
};

export async function POST(
    req: Request,
) {
    try {
        const { command } = await req.json();
        if (command === 'start') {
            initializeReader(deviceInfo);
            bindSerialPort.open((err) => {
                if (err) {
                    console.error('Error opening port: ', err.message);
                    return new NextResponse("Failed to open port", { status: 501 });
                }
                console.log('RFID reading started.');
                // bindSerialPort.on('data', (data) => {
                //     console.log(data.toString());
                // });
                parser.on('data', (data) => {
                    console.log("TAG:", data);      // Handle tag data here
                });
                return new NextResponse("RFID tags recieved!", { status: 200 });
            });
        } else if (command === 'stop') {
            if (bindSerialPort.isOpen) {
                bindSerialPort.close((err) => {
                    if (err) {
                        console.error('Error closing port: ', err.message);
                        return new NextResponse("Failed to close port", { status: 501 });
                    }
                    console.log('RFID reading stopped.');
                    return new NextResponse("RFID reading stopped!", { status: 200 });
                });
            }
        }
        return new NextResponse("Pass the command with API request!", { status: 502 });
    } catch (error) {
        console.error("[READ_RFID]", error);
        return new NextResponse("Internal Error", { status: 500 });
    }
}